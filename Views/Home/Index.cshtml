<h2>Home view</h2>

<button id="runOperation">Run operation</button>

<ul id="operationsList">

</ul>

@section scripts {
        <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="~/Scripts/jquery-2.1.3.js"></script>
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <script>
        $(function () {
            // Reference the auto-generated proxy for the hub.  
            var operationsHub = $.connection.operationsHub,
                $operationsList = $('#operationsList');
            
            
            function updateOperationsList(operations) {
                var currentTasks = operations || [];

                //clear list
                $operationsList.html('');

                currentTasks.forEach(addOperationToList);
            }

            function addOperationToList(task) {
                return $operationsList.append('<li data-id="' + task.Id + '"><span><b>'
                    + task.Id + ' </b></span><span class="js-progress">'
                    + task.Progress + '%</span> '
                    + task.Name + '<button class="js-cancel-operation">Cancel</button></li>');
            }

            //client methods that can be called from server
            operationsHub.client.progressChanged = function (operation) {

                var $operation = $operationsList.find('[data-id=' + operation.Id + ']');
                if (!$operation.length) {
                    addOperationToList(operation).find('.js-progress').html(operation.Progress);
                } else {
                    $operation.find('.js-progress').html(operation.Progress);
                }
            };
            operationsHub.client.operationCompleted = function (id) {
                $operationsList.find('[data-id=' + id + ']').remove();
            };

            // Init operations list
            function init() {

                //call server method from client
                operationsHub.server.getAllOperations().done(updateOperationsList);

                $('#runOperation').on('click', function () {
                    //call server method from client
                    operationsHub.server.runNewOperation();
                });

                $operationsList.on('click', '.js-cancel-operation', function (e) {

                    var operationId = $(e.target).parent('li').data('id');

                    //call server method from client
                    operationsHub.server.cancelOperation(operationId);
                });
            }

            // Start the connection
            $.connection.hub.logging = true;
            $.connection.hub.start().done(init);
        });
    </script>
}